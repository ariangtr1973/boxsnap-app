<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BoxSnap Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .main-container { max-width: 1000px; margin: 0 auto; min-height: 100vh; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
        .btn-primary { transition: all .2s; background-color: #10B981; }
        .btn-primary:hover { background-color: #059669; }
        .btn-primary:active { transform: scale(.98); }
        #message-box { position: fixed; top: 50%; left:50%; transform: translate(-50%,-50%); z-index:1000; padding:1rem 2rem; border-radius:.75rem; box-shadow: 0 0 20px rgba(0,0,0,.3); display:none; text-align:center; }
    </style>
</head>
<body>
    <div id="app" class="main-container p-4 sm:p-6 lg:p-8">
        <div id="message-box" class="card"></div>

        <header class="flex justify-between items-center py-4 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <!-- icon -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 mr-2 text-emerald-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5v-8.25m17.25 0a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75" />
                </svg>
                BoxSnap Cloud
            </h1>
            <div class="flex items-center gap-3">
                <button id="settings-btn" class="text-gray-500 hover:text-emerald-500 transition-colors">Settings</button>
            </div>
        </header>

        <div id="content"></div>

        <button id="add-box-btn" class="fixed bottom-6 right-6 p-4 rounded-full bg-emerald-600 text-white shadow-lg hover:bg-emerald-700 transition-colors flex items-center hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            <span class="ml-2">Add Box</span>
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection,
            query, 
            orderBy, 
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        // NOTE: The app expects a global __firebase_config JSON string injected by hosting or dev environment.
        // If not provided, set firebaseConfig here (ONLY for local testing). Replace with your real config if needed.
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : (window.__LOCAL_FIREBASE_CONFIG || null);

        // appId: prefer firebase projectId so storage paths align with your Firestore structure
        let appId = 'boxsnap-v1';

        // Gemini key stored in localStorage under 'gemini_key'
        const storedGeminiKey = (() => { try { return localStorage.getItem('gemini_key') || ''; } catch { return ''; } })();

        // runtime state
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentView = { view: 'list', boxId: null };
        let unsubscribeBoxes = null;
        let boxListState = [];

        // ----- Utility -----
        function showMessage(text, isError=false, duration=3000) {
            const m = document.getElementById('message-box');
            m.textContent = text;
            m.className = 'card ' + (isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800');
            m.style.display = 'block';
            setTimeout(()=>{ m.style.display = 'none'; }, duration);
        }

        function navigate(view, boxId=null) {
            currentView = { view, boxId };
            render();
            document.getElementById('add-box-btn').classList.toggle('hidden', view !== 'list');
        }

        // ----- Firebase init / auth fix -----
        async function initializeFirebase() {
            if (!firebaseConfig) {
                renderConnectionFailed("auth/configuration-not-found", "Firebase configuration is missing. Provide __firebase_config or set window.__LOCAL_FIREBASE_CONFIG for testing.");
                return;
            }

            try {
                // set appId from projectId if available
                if (firebaseConfig.projectId) appId = firebaseConfig.projectId;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Proper onAuthStateChanged flow:
                const authPromise = new Promise((resolve, reject) => {
                    const unsub = onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            userId = u.uid;
                            isAuthReady = true;
                            unsub();
                            resolve(u);
                        } else {
                            // no user yet - attempt sign-in
                            try {
                                const token = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : null;
                                if (token) {
                                    await signInWithCustomToken(auth, token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                // next onAuthStateChanged call will resolve
                            } catch (e) {
                                // fallback: assign a local random id so UI doesn't crash, but warn
                                userId = crypto.randomUUID();
                                isAuthReady = true;
                                unsub();
                                console.error("Auth fallback (anonymous) failed:", e);
                                // still resolve to let UI proceed — user will get DB failures if Firestore rules block unauth.
                                resolve(null);
                            }
                        }
                    }, (err) => {
                        unsub();
                        reject(err);
                    });
                });

                await authPromise;
                // start rendering
                navigate('list');
            } catch (err) {
                console.error("Firebase initialization error:", err);
                renderConnectionFailed(err.code || 'init-error', err.message || String(err), firebaseConfig.apiKey);
            }
        }

        // ----- Firestore functions -----
        const getPrivateCollectionPath = (collectionName) => `artifacts/${appId}/users/${userId}/${collectionName}`;

        function subscribeToBoxes(setBoxes) {
            if (!isAuthReady || !userId || !db) return;
            if (unsubscribeBoxes) unsubscribeBoxes();

            const boxesRef = collection(db, getPrivateCollectionPath('boxes'));
            const q = query(boxesRef); // basic query — ordering done in-memory
            unsubscribeBoxes = onSnapshot(q, (snapshot) => {
                const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // normalize timestamp and sort
                list.sort((a,b) => {
                    const tA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const tB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return tB - tA;
                });
                setBoxes(list);
            }, (err) => {
                console.error("subscribeToBoxes error:", err);
                showMessage("Real-time DB error. Check rules/console.", true);
            });
            return unsubscribeBoxes;
        }

        async function saveBoxToCloud(boxData) {
            if (!isAuthReady || !userId || !db) {
                showMessage("Auth not ready. Cannot save.", true);
                return { success:false, error: "Auth not ready" };
            }
            const boxesPath = getPrivateCollectionPath('boxes');
            const boxRef = boxData.id ? doc(db, boxesPath, boxData.id) : doc(collection(db, boxesPath));
            const dataToSave = {
                ...boxData,
                timestamp: serverTimestamp(),
                userId
            };
            try {
                await setDoc(boxRef, dataToSave, { merge: true });
                return { success: true, id: boxRef.id };
            } catch (err) {
                console.error("saveBoxToCloud error:", err);
                return { success:false, error: err.message || String(err) };
            }
        }

        // ----- Gemini AI helpers (uses key from localStorage) -----
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models";

        async function fetchWithBackoff(url, options, maxRetries=4) {
            for (let i=0;i<maxRetries;i++){
                try {
                    const r = await fetch(url, options);
                    if (!r.ok) {
                        const errBody = await r.text().catch(()=>null);
                        throw new Error(`Status ${r.status} - ${errBody || r.statusText}`);
                    }
                    return await r.json();
                } catch (err) {
                    if (i === maxRetries-1) throw err;
                    const delay = Math.pow(2, i) * 500 + Math.random()*300;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        function currentGeminiKey() {
            try { return localStorage.getItem('gemini_key') || ''; } catch { return ''; }
        }

        async function detectItemsFromImage(imageData, userPrompt='') {
            const key = currentGeminiKey();
            if (!key) { showMessage('Gemini API key missing — open Settings to paste it.', true); return null; }
            const apiUrl = `${API_BASE_URL}/${MODEL_NAME}:generateContent?key=${key}`;
            const prompt = `List distinct items visible in this image, comma-separated, then a short box name. Output ONLY a JSON object {"items": "...", "box_name": "..."} with no extra text. Context:${userPrompt}`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: imageData } }]
                }]
            };
            try {
                const resp = await fetchWithBackoff(apiUrl, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const jsonText = resp?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Empty response from Gemini");
                return JSON.parse(jsonText);
            } catch (err) {
                showMessage(`AI Error: ${err.message}`, true);
                console.error("detectItemsFromImage error:", err);
                return null;
            }
        }

        // ----- Rendering -----
        function renderListView(boxes) {
            const contentDiv = document.getElementById('content');
            let userLabel = userId ? (userId.length>8 ? userId.substring(0,8) + '...' : userId) : 'guest';
            contentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">My Boxes (${boxes.length})</h2>
                    <span class="text-sm text-gray-500">User: ${userLabel}</span>
                </div>
                <div id="boxes-list" class="space-y-4">
                    ${boxes.length === 0 ? `<p class="text-center py-12 text-gray-500 card">You haven't packed any boxes yet. Click 'Add Box' to start!</p>` : boxes.map(box => `
                        <div class="card p-4 flex items-center justify-between hover:shadow-lg transition-shadow cursor-pointer" data-box-id="${box.id}">
                            <div>
                                <p class="text-lg font-bold text-emerald-600">${box.boxName || 'Unnamed Box'}</p>
                                <p class="text-sm text-gray-500 truncate max-w-sm">${box.contents || 'No contents listed.'}</p>
                                <p class="text-xs text-gray-400 mt-1">Location: ${box.location || 'N/A'} - ${box.timestamp ? new Date(box.timestamp.toMillis()).toLocaleString() : 'N/A'}</p>
                            </div>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full" data-box-id="${box.id}">
                                Delete
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            // wire up clicks
            contentDiv.querySelectorAll('.card[data-box-id]').forEach(card => card.addEventListener('click', () => navigate('edit', card.dataset.boxId)));
            contentDiv.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); window.deleteBox(btn.dataset.boxId); }));
            document.getElementById('add-box-btn').classList.remove('hidden');
        }

        function renderPackView(box = {}) {
            const contentDiv = document.getElementById('content');
            const categories = ["Living Room","Kitchen","Bedroom 1","Office","Garage","Storage"];
            contentDiv.innerHTML = `
                <div class="flex items-center mb-6">
                    <button id="back-to-list" class="text-gray-500 hover:text-gray-700 mr-4">Back</button>
                    <h2 class="text-2xl font-semibold text-gray-700">${box.id ? 'Edit Box':'Pack New Box'}</h2>
                </div>
                <div class="card p-6 space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                        <div id="image-preview" class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center cursor-pointer text-gray-500 text-sm overflow-hidden relative">
                            ${box.image ? `<img src="data:image/png;base64,${box.image}" class="w-full h-full object-cover">` : `<span id="upload-text">Click to upload image or take photo</span>`}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Optional: Upload an image of the box's contents for AI detection.</p>
                        <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <input type="text" id="ai-prompt" placeholder="Optional: Prompt (e.g., 'ignore the walls')" class="flex-grow p-2 border border-gray-300 rounded-lg">
                            <button id="detect-items-btn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Detect Items</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Box Name</label>
                        <input type="text" id="box-name" value="${box.boxName||''}" placeholder="e.g., 'Kitchen Utensils'" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contents (Comma Separated)</label>
                        <textarea id="contents" rows="4" class="w-full p-3 border border-gray-300 rounded-lg">${box.contents||''}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location / Category</label>
                        <select id="location" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="">Select a Location</option>
                            ${categories.map(c => `<option value="${c}" ${box.location===c?'selected':''}>${c}</option>`).join('')}
                        </select>
                    </div>

                    <button id="save-box-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg shadow-md">Save to Cloud</button>
                </div>
            `;

            document.getElementById('back-to-list').addEventListener('click', ()=>navigate('list'));
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            const detectBtn = document.getElementById('detect-items-btn');
            const saveBtn = document.getElementById('save-box-btn');
            let base64Image = box.image || null;

            imagePreview.addEventListener('click', ()=> imageUpload.click());
            imageUpload.addEventListener('change', (ev) => {
                const f = ev.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    base64Image = dataUrl.split(',')[1];
                    imagePreview.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(f);
            });

            saveBtn.addEventListener('click', async () => {
                const boxName = (document.getElementById('box-name').value || '').trim();
                const contents = (document.getElementById('contents').value || '').trim();
                const location = (document.getElementById('location').value || '').trim();
                if (!boxName || !contents || !location) { showMessage("Please fill in Box Name, Contents, and Location.", true); return; }
                saveBtn.textContent = 'Saving...'; saveBtn.disabled = true; saveBtn.classList.remove('btn-primary'); saveBtn.classList.add('bg-gray-400');

                const data = { id: box.id || undefined, boxName, contents, location, image: base64Image || null };
                const res = await saveBoxToCloud(data);
                if (res.success) {
                    showMessage(box.id ? `Box updated` : `Box saved`);
                    navigate('list');
                } else {
                    showMessage(`Save failed: ${res.error}`, true, 5000);
                    saveBtn.textContent = 'Save to Cloud'; saveBtn.disabled = false; saveBtn.classList.remove('bg-gray-400'); saveBtn.classList.add('btn-primary');
                }
            });

            detectBtn.addEventListener('click', async () => {
                if (!base64Image) { showMessage("Upload an image first to detect items.", true); return; }
                detectBtn.textContent = 'Thinking...'; detectBtn.disabled = true;
                const prompt = document.getElementById('ai-prompt').value || '';
                const result = await detectItemsFromImage(base64Image, prompt);
                detectBtn.textContent = 'Detect Items'; detectBtn.disabled = false;
                if (result) {
                    document.getElementById('box-name').value = result.box_name || '';
                    document.getElementById('contents').value = result.items || '';
                    showMessage("AI detection complete — review results.");
                }
            });
        }

        function renderSettingsView() {
            const contentDiv = document.getElementById('content');
            const currentKey = localStorage.getItem('gemini_key') || '';
            contentDiv.innerHTML = `
                <div class="card p-6 max-w-lg mx-auto">
                    <h2 class="text-xl font-semibold mb-4">Settings</h2>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <input id="gemini-key-input" class="w-full p-3 border border-gray-300 rounded-lg font-mono" value="${currentKey}" placeholder="Paste your Gemini API key here">
                    <p class="text-xs text-gray-500 mt-2">Required for AI detection (optional if you don't use AI).</p>
                    <div class="mt-6 flex gap-2">
                        <button id="save-key-btn" class="flex-1 btn-primary text-white py-2 rounded-lg">Save Key</button>
                        <button id="back-btn" class="flex-1 bg-gray-200 py-2 rounded-lg">Back</button>
                    </div>
                </div>
            `;
            document.getElementById('save-key-btn').addEventListener('click', () => {
                const val = document.getElementById('gemini-key-input').value.trim();
                try { localStorage.setItem('gemini_key', val); showMessage('Gemini key saved'); } catch (e) { showMessage('Could not save key', true); }
            });
            document.getElementById('back-btn').addEventListener('click', () => navigate('list'));
        }

        function renderConnectionFailed(errorCode, message, key) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="card p-8 max-w-lg mx-auto mt-24 text-center">
                    <h2 class="text-2xl font-bold text-red-600 mb-4">Connection Failed</h2>
                    <p class="text-red-500 mb-2">Firebase Error: (${errorCode})</p>
                    <p class="text-sm text-gray-700 mb-4">${message}</p>
                    ${key ? `<p class="text-xs text-gray-500 mt-2">Key Present: ${String(key).substring(0,8)}...</p>` : ''}
                    <div class="mt-6 text-left">
                        <p class="font-semibold text-gray-800">Troubleshooting:</p>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                            <li>Check your internet connection.</li>
                            <li>Turn off browser shields / adblock for this page (Brave).</li>
                            <li>Ensure Firestore rules are published and allow your auth method.</li>
                        </ul>
                    </div>
                    <button id="retry-btn" class="w-full mt-8 bg-gray-800 text-white font-bold py-3 px-4 rounded-lg">Retry</button>
                </div>
            `;
            document.getElementById('retry-btn').addEventListener('click', () => window.location.reload());
        }

        // Main renderer
        function render() {
            if (!isAuthReady) {
                document.getElementById('content').innerHTML = `<div class="text-center py-20"><p class="text-lg text-emerald-600 font-semibold">Connecting to Cloud...</p><div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mx-auto"></div></div>`;
                return;
            }

            // If list view, ensure subscription
            if (currentView.view === 'list') {
                if (!unsubscribeBoxes) {
                    subscribeToBoxes((boxes) => {
                        boxListState = boxes;
                        if (currentView.view === 'list') renderListView(boxListState);
                    });
                } else {
                    renderListView(boxListState);
                }
                return;
            }
            if (currentView.view === 'pack') { renderPackView({}); return; }
            if (currentView.view === 'edit') {
                const b = boxListState.find(x => x.id === currentView.boxId);
                if (b) renderPackView(b); else { showMessage('Box not found', true); navigate('list'); }
                return;
            }
            if (currentView.view === 'settings') { renderSettingsView(); return; }
            navigate('list');
        }

        // Expose deleteBox globally for inline onclick removal used in list HTML
        window.deleteBox = async (boxId) => {
            if (!confirm('Delete this box?')) return;
            try {
                const boxRef = doc(db, getPrivateCollectionPath('boxes'), boxId);
                await deleteDoc(boxRef);
                showMessage('Box deleted');
            } catch (err) {
                console.error("deleteBox error:", err);
                showMessage('Delete failed', true);
            }
        };

        // global buttons
        document.getElementById('add-box-btn').addEventListener('click', () => navigate('pack'));
        document.getElementById('settings-btn').addEventListener('click', () => navigate('settings'));

        // Start
        initializeFirebase();

    </script>
</body>
</html>
