<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxSnap Cloud</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0LeYLcn0R9YjiWg1OptAUMX4ZRsTtWpE",
            authDomain: "boxsnap-b5d3d.firebaseapp.com",
            projectId: "boxsnap-b5d3d",
            storageBucket: "boxsnap-b5d3d.appspot.com",
            messagingSenderId: "792190274154",
            appId: "1:792190274154:web:8f251191a14387b2365813"
        };

        // App ID for Firestore path
        const APP_ID = "boxsnap-mobile-v1";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.boxsnap = { status: 'initializing', error: null };
        window.db = db;
        window.auth = auth;
        window.fs = { collection, doc, setDoc, onSnapshot, deleteDoc, query, orderBy };
        window.appId = APP_ID;
        window.boxsnap.status = 'ready';

        // Anonymous auth
        signInAnonymously(auth).then(() => console.log("Firebase Auth: Anonymous sign-in successful."))
        .catch(e => { 
            console.error("Firebase Auth Error:", e);
            window.boxsnap.error = "Auth Failed: " + e.message;
            window.boxsnap.status = 'error';
        });
    </script>

    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React App -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ d, className="" }) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>;

        const Icons = {
            arrowLeft: "m12 19-7-7 7-7 M19 12H5",
            camera: "M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 13m-3 0a3 3 0 1 0 6 0a3 3 0 1 0-6 0",
            check: "M20 6 9 17l-5-5",
            package: "M16.5 9.4 7.5 4.21 M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z M3.3 7l8.7 5 8.7-5 M12 22v-10",
            trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            plus: "M12 5v14 M5 12h14"
        };

        const STATUS_STEPS = ['Packing', 'Ready', 'Loaded', 'Unpacked'];

        function App() {
            const [boxes, setBoxes] = useState([]);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [dbStatus, setDbStatus] = useState(window.boxsnap.status || 'init');
            const [errorMsg, setErrorMsg] = useState(window.boxsnap.error || '');

            const [newBox, setNewBox] = useState({ name: '', room: 'Living Room', items: [], images: [], status: 'Packing' });
            const fileRef = useRef(null);
            const ROOMS = ['Living Room', 'Kitchen', 'Master Bedroom', 'Guest Room', 'Garage', 'Basement', 'Storage Unit'];
            const STATUS_COLORS = { 'Packing': 'bg-gray-100 text-gray-600', 'Ready': 'bg-blue-100 text-blue-700', 'Loaded': 'bg-purple-100 text-purple-700', 'Unpacked': 'bg-green-100 text-green-700' };

            // Firebase auth & snapshot
            useEffect(() => {
                if (window.boxsnap.status === 'missing_config' || window.boxsnap.status === 'error') {
                    setDbStatus(window.boxsnap.status);
                    setErrorMsg(window.boxsnap.error);
                    return;
                }

                setDbStatus('connecting');

                const unsubscribeAuth = window.auth.onAuthStateChanged(u => {
                    if (u) {
                        setUser(u);
                        setDbStatus('connected');
                        const q = window.fs.query(window.fs.collection(window.db, `artifacts/${window.appId}/users/${u.uid}/boxes`));
                        const unsubscribeData = window.fs.onSnapshot(q, snapshot => {
                            setBoxes(snapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>b.createdAt - a.createdAt));
                        }, err => {
                            console.error("Firestore Permission Error:", err);
                            setErrorMsg("Permission Denied. Did you publish the Security Rules?");
                            setDbStatus('error');
                        });
                        return () => unsubscribeData();
                    }
                });
                return () => { if (unsubscribeAuth) unsubscribeAuth(); }
            }, []);

            const saveBox = async () => {
                if(!user) return alert("Cloud not connected.");
                if(!newBox.name) return alert("Enter Box Name.");
                try {
                    await window.fs.setDoc(window.fs.doc(window.db, `artifacts/${window.appId}/users/${user.uid}/boxes`, `box_${Date.now()}`), { ...newBox, createdAt: Date.now() });
                    setNewBox({ name: '', room: 'Living Room', items: [], images: [], status: 'Packing' });
                    setView('dashboard');
                } catch(e) { alert("Save Failed: " + e.message); }
            };

            // Dashboard view
            if(dbStatus === 'error') return (
                <div className="p-8 min-h-screen flex items-center justify-center bg-red-50">
                    <div className="bg-white p-6 rounded-xl shadow-xl max-w-md text-center">
                        <h1 className="text-xl font-bold text-red-600 mb-4">Error</h1>
                        <p className="text-slate-600">{errorMsg}</p>
                    </div>
                </div>
            );

            return (
                <div className="p-5 bg-slate-50 min-h-screen pb-24">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-black flex items-center gap-2 text-slate-900"><Icon d={Icons.package} className="w-6 h-6"/> BoxSnap</h1>
                    </div>
                    <div className="space-y-3">
                        {boxes.map(box => (
                            <div key={box.id} className="bg-white p-4 rounded-xl shadow-sm flex flex-col gap-2 border-t-4 border-indigo-500">
                                <div className="flex justify-between items-start">
                                    <div className="flex gap-3">
                                        <div className="w-12 h-12 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0">
                                            {box.images[0] ? <img src={box.images[0]} className="w-full h-full object-cover"/> : <Icon d={Icons.package} className="w-8 h-8 text-slate-400 mx-auto my-2"/>}
                                        </div>
                                        <div className="flex flex-col">
                                            <h3 className="font-bold text-lg text-slate-900">{box.name}</h3>
                                            <p className="text-xs text-indigo-600 font-medium bg-indigo-50 px-2 py-0.5 rounded-full mt-0.5">{box.room}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-black text-white p-4 rounded-full shadow-xl flex items-center gap-2 hover:bg-gray-800 transition-colors">
                        <Icon d={Icons.plus} className="w-6 h-6"/> Add Box
                    </button>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
