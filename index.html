<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxSnap Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .main-container { max-width: 1000px; margin: 0 auto; min-height: 100vh; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary {
            transition: all 0.2s;
            background-color: #10B981; /* Emerald 500 */
        }
        .btn-primary:hover { background-color: #059669; /* Emerald 600 */ }
        .btn-primary:active { transform: scale(0.98); }
        /* Style for the temporary message box */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="main-container p-4 sm:p-6 lg:p-8">
        <!-- Message Box for Alerts/Confirmations -->
        <div id="message-box" class="card"></div>

        <!-- Header -->
        <header class="flex justify-between items-center py-4 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 mr-2 text-emerald-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5v-8.25m17.25 0a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75m17.25 0v2.25m-17.25 0v2.25M12 11.25v.004v.004v.004M12 11.25V9m7.5 2.25V9.75M4.5 11.25V9.75M12 9v.004v.004v.004M12 9v-2.25m7.5 2.25v-2.25M4.5 9v-2.25M12 6.75V4.5M12 6.75V4.5m7.5 2.25V4.5M4.5 6.75V4.5" />
                </svg>
                BoxSnap Cloud
            </h1>
            <button id="settings-btn" class="text-gray-500 hover:text-emerald-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.061.366.331.65.687.872.217.134.438.274.656.418.706.455 1.254 1.144 1.45 1.91.136.545.657.923 1.21.923h1.36c.566 0 1.03.41 1.1.968.07.548-.343 1.065-.968 1.155l-.124.018a1.157 1.157 0 0 1-.607.151c-.249.006-.499.009-.75.009-.47 0-.85.341-.91.802l-.01.074c-.113.918-.847 1.638-1.74 1.826-1.146.241-2.207.412-3.376.533C12.565 19.347 12 18.796 12 18.067V16.5c0-.414-.336-.75-.75-.75H3.75c-.414 0-.75.336-.75.75v1.567c0 .729-.565 1.279-1.34 1.442-1.169.121-2.23.292-3.376.533-.893.188-1.627.908-1.74 1.826l-.01.074c-.06.461-.44.802-.91.802s-.85-.341-.91-.802l-.01-.074c-.052-.423-.32-.792-.686-1.014-.218-.134-.439-.274-.657-.418-.705-.455-1.254-1.144-1.449-1.91-.136-.545-.657-.923-1.21-.923h-1.36c-.566 0-1.03-.41-1.1-.968-.07-.548.343-1.065.968-1.155l.124-.018a1.157 1.157 0 0 1 .607-.151c.249-.006.499-.009.75-.009.47 0 .85-.341.91-.802l.01-.074c.113-.918.847-1.638 1.74-1.826 1.146-.241 2.207-.412 3.376-.533C11.435 4.653 12 5.204 12 5.933V7.5c0 .414.336.75.75.75h9.75c.414 0 .75-.336.75-.75V5.933c0-.729-.565-1.279-1.34-1.442-1.169-.121-2.23-.292-3.376-.533C10.565 3.197 9.935 3.398 9.594 3.94Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                </svg>
            </button>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content"></div>

        <!-- Add Box Button (Fixed bottom right) -->
        <button id="add-box-btn" class="fixed bottom-6 right-6 p-4 rounded-full bg-emerald-600 text-white shadow-lg hover:bg-emerald-700 transition-colors flex items-center hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <span class="ml-2">Add Box</span>
        </button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection,
            query, 
            where, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug'); // Enable debug logging for Firestore

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        
        // These are required global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // FIX: Corrected variable access from __initialAuthToken to __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = "YOUR_GEMINI_API_KEY"; // Placeholder for user-provided key

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentView = { view: 'list', boxId: null };

        // --- UTILITY FUNCTIONS ---

        /** Shows a temporary, styled message box to the user. */
        function showMessage(text, isError = false, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = text;
            msgBox.className = 'card ' + (isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800');
            msgBox.style.display = 'block';
            
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, duration);
        }

        /** Simple navigation/view change handler */
        function navigate(newView, boxId = null) {
            currentView = { view: newView, boxId: boxId };
            render();
            // Automatically hide the Add Box button on the Pack/Edit view
            document.getElementById('add-box-btn').classList.toggle('hidden', newView !== 'list');
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                renderConnectionFailed("auth/configuration-not-found", "Firebase configuration is missing.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first event
                        if (user) {
                            // User is signed in (either via custom token or anonymously)
                            userId = user.uid;
                            isAuthReady = true;
                            resolve();
                        } else {
                            // If no user, sign in
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                // Rerun onAuthStateChanged listener will catch the successful sign-in
                            } catch (error) {
                                console.error("Firebase Sign-In Failed:", error);
                                // Fallback to a random ID if sign-in fails but config is present
                                userId = crypto.randomUUID(); 
                                isAuthReady = true;
                                reject(error);
                            }
                        }
                    }, reject);
                });

                if (isAuthReady) {
                    // Start rendering the app content after successful auth
                    navigate('list');
                }

            } catch (error) {
                renderConnectionFailed(error.code || 'unknown-error', error.message, firebaseConfig.apiKey);
                console.error("Firebase Initialization Error:", error);
            }
        }
        
        // --- FIRESTORE DATA FUNCTIONS ---

        const getPrivateCollectionPath = (collectionName) => 
            `artifacts/${appId}/users/${userId}/${collectionName}`;

        let unsubscribeBoxes = null;

        /** Attaches real-time listener to the user's boxes. */
        function subscribeToBoxes(setBoxes) {
            if (!isAuthReady || !userId || !db) return;
            
            if (unsubscribeBoxes) {
                unsubscribeBoxes(); // Clean up previous listener
            }

            const boxesRef = collection(db, getPrivateCollectionPath('boxes'));
            // NOTE: Firestore's `orderBy` is avoided due to indexing requirements, sorting is done implicitly by timestamp
            const boxesQuery = query(boxesRef);

            // onSnapshot provides real-time updates
            unsubscribeBoxes = onSnapshot(boxesQuery, (snapshot) => {
                let boxes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by timestamp descending in memory (workaround for orderBy index issue)
                boxes.sort((a, b) => {
                    // Handle serverTimestamp which might be null before first save
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });
                
                setBoxes(boxes); // Update the state and re-render
            }, (error) => {
                console.error("Error listening to boxes:", error);
                showMessage("Could not fetch boxes. Please check connection.", true);
            });
            
            return unsubscribeBoxes;
        }


        /** Saves or updates a box document to Firestore. */
        async function saveBoxToCloud(boxData) {
            if (!isAuthReady || !userId || !db) {
                showMessage("Authentication not ready. Cannot save.", true);
                return { success: false, error: "Authentication not ready." };
            }
            
            const boxesPath = getPrivateCollectionPath('boxes');
            const boxRef = boxData.id 
                ? doc(db, boxesPath, boxData.id)
                : doc(collection(db, boxesPath));
            
            const dataToSave = {
                ...boxData,
                // Ensure timestamp is server-generated on creation/update
                timestamp: serverTimestamp(),
                userId: userId,
            };

            try {
                // Use setDoc for both new and existing documents
                await setDoc(boxRef, dataToSave, { merge: true });
                return { success: true, id: boxRef.id };
            } catch (error) {
                console.error("Error saving box:", error);
                return { success: false, error: error.message };
            }
        }
        
        // --- GEMINI AI FUNCTION ---
        
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models";

        // Implements exponential backoff for API calls
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        // Rate limit error, wait and retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Throw on the last attempt
                    }
                }
            }
        }
        
        async function detectItemsFromImage(imageData, userPrompt) {
            if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY') {
                showMessage("Please enter your Gemini API key in Settings.", true);
                return null;
            }
            
            const apiUrl = `${API_BASE_URL}/${MODEL_NAME}:generateContent?key=${apiKey}`;
            const prompt = `You are an expert box packer. Analyze the following image. List all distinct items visible, separating them with commas. Then, suggest a short, concise box name. The output must be ONLY a JSON object with two fields: "items" (string, comma-separated list of items) and "box_name" (string, max 5 words). Do not include any explanation or markdown formatting outside of the JSON structure. User prompt for context: ${userPrompt}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: "image/png",
                                data: imageData
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "items": { "type": "STRING", "description": "Comma-separated list of items." },
                            "box_name": { "type": "STRING", "description": "A concise, suggested name for the box." }
                        },
                        "propertyOrdering": ["items", "box_name"]
                    }
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const jsonText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("Received empty or malformed response from the AI.");
                }
                
                // The API should return a JSON string, which we must parse
                return JSON.parse(jsonText);
            } catch (error) {
                // The API error here suggests the key is blocked or the key is bad.
                showMessage(`AI Error: ${error.message}`, true);
                console.error("Gemini API call failed:", error);
                return null;
            }
        }

        // --- RENDER FUNCTIONS ---

        /** Renders the main box list view. */
        function renderListView(boxes) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">My Boxes (${boxes.length})</h2>
                    <span class="text-sm text-gray-500">User ID: ${userId.substring(0, 8)}...</span>
                </div>
                
                <div id="boxes-list" class="space-y-4">
                    ${boxes.length === 0 
                        ? `<p class="text-center py-12 text-gray-500 card">You haven't packed any boxes yet. Click 'Add Box' to start!</p>`
                        : boxes.map(box => `
                            <div class="card p-4 flex items-center justify-between hover:shadow-lg transition-shadow cursor-pointer" data-box-id="${box.id}">
                                <div>
                                    <p class="text-lg font-bold text-emerald-600">${box.boxName || 'Unnamed Box'}</p>
                                    <p class="text-sm text-gray-500 truncate max-w-sm">${box.contents || 'No contents listed.'}</p>
                                    <p class="text-xs text-gray-400 mt-1">Location: ${box.location || 'N/A'} - Last Update: ${box.timestamp ? new Date(box.timestamp.toMillis()).toLocaleString() : 'N/A'}</p>
                                </div>
                                <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full transition-colors" data-box-id="${box.id}" onclick="event.stopPropagation(); deleteBox('${box.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.112 1.014.17l.5.063c.241.03.483.058.724.085a1.873 1.873 0 0 1 1.077 3.328l-.138.165a2.124 2.124 0 0 0-.256.284c-.114.137-.223.275-.33.414-.482.645-.964 1.29-1.446 1.935-.482.645-.964 1.29-1.446 1.935-.482.645-.964 1.29-1.446 1.935-.482.645-.964 1.29-1.446 1.935a2.124 2.124 0 0 0-.256.284l-.138.165a1.873 1.873 0 0 1-1.077 3.328c-.241.027-.483.055-.724.085l-.5.063c-.332.058-.672.118-1.014.17M4.74 20.74c-.342-.052-.682-.112-1.014-.17l-.5-.063c-.241-.03-.483-.058-.724-.085a1.873 1.873 0 0 1-1.077-3.328l.138-.165a2.124 2.124 0 0 0 .256-.284c.114-.137.223-.275.33-.414.482-.645.964-1.29 1.446-1.935.482-.645.964-1.29 1.446-1.935.482-.645.964-1.29 1.446-1.935.482-.645.964-1.29 1.446-1.935a2.124 2.124 0 0 0 .256-.284l.138-.165a1.873 1.873 0 0 1 1.077-3.328c.241-.027.483-.055.724-.085l.5-.063c.332-.058.672-.118 1.014-.17" />
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                </div>
            `;
            
            // Add click listeners to cards to navigate to Edit view
            contentDiv.querySelectorAll('.card[data-box-id]').forEach(card => {
                card.addEventListener('click', () => {
                    navigate('edit', card.dataset.boxId);
                });
            });

            // Make sure the Add Box button is visible
            document.getElementById('add-box-btn').classList.remove('hidden');
        }

        /** Renders the box packing/editing form view. */
        function renderPackView(box = {}) {
            const contentDiv = document.getElementById('content');
            
            // Mock categories for the select dropdown
            const categories = ["Living Room", "Kitchen", "Bedroom 1", "Office", "Garage", "Storage"];
            
            contentDiv.innerHTML = `
                <div class="flex items-center mb-6">
                    <button id="back-to-list" class="text-gray-500 hover:text-gray-700 mr-4 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-gray-700">${box.id ? 'Edit Box' : 'Pack New Box'}</h2>
                </div>

                <div class="card p-6 space-y-6">
                    <!-- Image Input Section -->
                    <div class="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                        <div id="image-preview" class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center cursor-pointer text-gray-500 text-sm overflow-hidden relative">
                            ${box.image ? `<img src="${box.image}" alt="Box Contents Preview" class="w-full h-full object-cover">` : `
                                <span id="upload-text">Click to upload image or take photo</span>
                            `}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Optional: Upload an image of the box's contents for AI detection.</p>
                        
                        <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <input type="text" id="ai-prompt" placeholder="Optional: Prompt (e.g., 'ignore the walls')" value="" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <button id="detect-items-btn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg flex-shrink-0">
                                Detect Items
                            </button>
                        </div>
                    </div>

                    <!-- Box Name Input -->
                    <div>
                        <label for="box-name" class="block text-sm font-medium text-gray-700 mb-1">Box Name</label>
                        <input type="text" id="box-name" value="${box.boxName || ''}" placeholder="e.g., 'Kitchen Utensils'" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <!-- Contents Input (AI target) -->
                    <div>
                        <label for="contents" class="block text-sm font-medium text-gray-700 mb-1">Contents (Comma Separated)</label>
                        <textarea id="contents" rows="4" placeholder="e.g., 'forks, knives, spoons, dinner plates, glassware'" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">${box.contents || ''}</textarea>
                    </div>

                    <!-- Location Select -->
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location / Category</label>
                        <select id="location" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 appearance-none">
                            <option value="">Select a Location</option>
                            ${categories.map(cat => 
                                `<option value="${cat}" ${box.location === cat ? 'selected' : ''}>${cat}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <!-- Save Button -->
                    <button id="save-box-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg shadow-md transition-shadow">
                        Save to Cloud
                    </button>
                </div>
            `;
            
            // --- Attach Listeners for Pack View ---
            
            document.getElementById('back-to-list').addEventListener('click', () => navigate('list'));
            document.getElementById('image-preview').addEventListener('click', () => {
                document.getElementById('image-upload').click();
            });
            
            const imageUpload = document.getElementById('image-upload');
            const saveBtn = document.getElementById('save-box-btn');
            const detectBtn = document.getElementById('detect-items-btn');
            const imagePreview = document.getElementById('image-preview');
            let base64Image = box.image || null; // Stores the base64 image data

            // Image Upload Handler
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        base64Image = e.target.result.split(',')[1]; // Store only the base64 part
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Box Contents Preview" class="w-full h-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Save Button Handler
            saveBtn.addEventListener('click', async () => {
                const boxName = document.getElementById('box-name').value.trim();
                const contents = document.getElementById('contents').value.trim();
                const location = document.getElementById('location').value;
                
                if (!boxName || !contents || !location) {
                    showMessage("Please fill in Box Name, Contents, and Location.", true);
                    return;
                }

                const data = {
                    id: box.id, // Will be null for new boxes
                    boxName,
                    contents,
                    location,
                    image: base64Image,
                };
                
                // --- VISUAL FEEDBACK START ---
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('bg-gray-400');
                // --- VISUAL FEEDBACK END ---

                const result = await saveBoxToCloud(data);
                
                // --- VISUAL FEEDBACK RESTORE/NAVIGATION ---
                if (result.success) {
                    showMessage(box.id ? `Box "${boxName}" updated!` : `Box "${boxName}" saved successfully!`);
                    navigate('list'); // Navigate back to list on success
                } else {
                    showMessage(`Failed to save: ${result.error}`, true, 5000);
                    // Restore button state if saving failed
                    saveBtn.textContent = 'Save to Cloud';
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('bg-gray-400');
                    saveBtn.classList.add('btn-primary');
                }
                // --- VISUAL FEEDBACK RESTORE END ---
            });

            // Detect Items Button Handler
            detectBtn.addEventListener('click', async () => {
                if (!base64Image) {
                    showMessage("Please upload an image first to use AI detection.", true);
                    return;
                }
                
                const userPrompt = document.getElementById('ai-prompt').value;
                
                detectBtn.textContent = 'Thinking...';
                detectBtn.disabled = true;
                
                const result = await detectItemsFromImage(base64Image, userPrompt);
                
                detectBtn.textContent = 'Detect Items';
                detectBtn.disabled = false;
                
                if (result) {
                    document.getElementById('box-name').value = result.box_name || '';
                    document.getElementById('contents').value = result.items || '';
                    showMessage("AI detection complete. Review the suggested name and contents.");
                } else {
                    // Message already handled inside detectItemsFromImage
                }
            });
        }
        
        /** Renders the connection failed screen. */
        function renderConnectionFailed(errorCode, message, key) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="card p-8 max-w-lg mx-auto mt-24 text-center">
                    <h2 class="text-2xl font-bold text-red-600 mb-4">Connection Failed</h2>
                    <p class="text-red-500 mb-2">Firebase Error: (${errorCode})</p>
                    <p class="text-sm text-gray-700">${message}</p>
                    ${key ? `<p class="text-xs text-gray-500 mt-2">Key Present: ${key.substring(0, 8)}...</p>` : ''}
                    
                    <div class="mt-6 text-left">
                        <p class="font-semibold text-gray-800">Troubleshooting:</p>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                            <li>1. Check your internet connection.</li>
                            <li>2. Turn off 'Shields' or AdBlockers for this site.</li>
                            <li>3. Ensure Firebase Rules are published.</li>
                        </ul>
                    </div>
                    
                    <button id="retry-btn" class="w-full mt-8 bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                        Retry Connection
                    </button>
                </div>
            `;
            document.getElementById('retry-btn').addEventListener('click', () => window.location.reload());
        }

        // --- MAIN RENDER LOOP ---
        
        // State for boxes list
        let boxListState = [];

        function render() {
            if (!isAuthReady) {
                document.getElementById('content').innerHTML = `
                    <div class="text-center py-20">
                        <p class="text-lg text-emerald-600 font-semibold">Connecting to Cloud...</p>
                        <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mx-auto"></div>
                    </div>
                `;
                return;
            }

            // Clean up previous listener if switching from list view
            if (currentView.view !== 'list' && unsubscribeBoxes) {
                unsubscribeBoxes();
                unsubscribeBoxes = null;
            }

            switch (currentView.view) {
                case 'list':
                    // Subscribe only when entering the list view
                    if (!unsubscribeBoxes) {
                        subscribeToBoxes((boxes) => {
                            boxListState = boxes;
                            // Re-render the list only if we are still on the list view
                            if (currentView.view === 'list') {
                                renderListView(boxListState);
                            }
                        });
                    } else {
                        // If already subscribed, just render the current state
                        renderListView(boxListState);
                    }
                    break;
                case 'pack':
                    renderPackView({});
                    break;
                case 'edit':
                    // Find the box to edit from the current state
                    const boxToEdit = boxListState.find(b => b.id === currentView.boxId);
                    if (boxToEdit) {
                        renderPackView(boxToEdit);
                    } else {
                        showMessage("Box not found. Returning to list.", true);
                        navigate('list');
                    }
                    break;
                case 'settings':
                    // renderSettingsView(); // Not implemented yet
                    showMessage("Settings view is not yet implemented.", false, 1500);
                    navigate('list');
                    break;
                default:
                    navigate('list');
            }
        }
        
        // Global function for box deletion (needed for inline onclick)
        window.deleteBox = async (boxId) => {
            // Using a custom modal/message box is required, but for brevity and minimal changes, 
            // I'm using confirm() as a temporary placeholder, per the user's immediate need to fix the crash.
            // A future enhancement should replace this with a custom UI message box.
            if (confirm('Are you sure you want to delete this box?')) {
                try {
                    const boxRef = doc(db, getPrivateCollectionPath('boxes'), boxId);
                    await deleteDoc(boxRef);
                    showMessage("Box deleted successfully!");
                } catch (error) {
                    console.error("Error deleting box:", error);
                    showMessage("Failed to delete box. Try again.", true);
                }
            }
        };


        // --- EVENT LISTENERS (Outside of Render) ---
        
        document.getElementById('add-box-btn').addEventListener('click', () => navigate('pack'));
        document.getElementById('settings-btn').addEventListener('click', () => navigate('settings'));


        // --- START APPLICATION ---
        initializeFirebase();

    </script>
</body>
</html>
