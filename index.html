<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxSnap Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Load Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body { height: 100%; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        /* Animation Utilities */
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- HELPER: Base64 Conversion for AI ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        };

        // --- HELPER: Icon Component ---
        const Icon = ({ name, size = 24, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- MOCK DATA ---
        const INITIAL_BOXES = [
            {
                id: 'bx-101',
                name: 'Kitchen Essentials',
                room: 'Kitchen',
                category: 'Fragile',
                items: ['Blender', 'Coffee Maker', 'Plates'],
                keywords: 'cooking, glass, ceramic', 
                createdAt: new Date().toISOString(),
                images: [] 
            }
        ];

        const ROOMS = ['Living Room', 'Kitchen', 'Master Bedroom', 'Guest Room', 'Garage', 'Basement'];
        const CATEGORIES = ['General', 'Fragile', 'Clothing', 'Electronics', 'Documents', 'Tools'];

        // --- MAIN APP COMPONENT ---
        function App() {
            // --- STATE ---
            const [boxes, setBoxes] = useState(() => {
                try {
                    const saved = localStorage.getItem('boxsnap_data_v9');
                    return saved ? JSON.parse(saved) : INITIAL_BOXES;
                } catch (e) { return INITIAL_BOXES; }
            });

            const [apiKey, setApiKey] = useState(() => localStorage.getItem('boxsnap_api_key') || '');
            const [view, setView] = useState('dashboard'); 
            const [newBox, setNewBox] = useState({ name: '', room: 'Living Room', category: 'General', items: [], images: [], keywords: '' });
            const [selectedBox, setSelectedBox] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [rawImageFile, setRawImageFile] = useState(null); // Critical for AI
            const fileInputRef = useRef(null);

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('boxsnap_data_v9', JSON.stringify(boxes));
                if (window.lucide) window.lucide.createIcons();
            }, [boxes, view, selectedBox, showSettings]);

            const saveApiKey = (val) => {
                setApiKey(val);
                localStorage.setItem('boxsnap_api_key', val);
            };

            // --- CORE LOGIC ---

            const handlePhotoUpload = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    setRawImageFile(file); // Store file for AI
                    const url = URL.createObjectURL(file); // Create preview URL
                    setNewBox(prev => ({ ...prev, images: [...prev.images, url] }));
                    e.target.value = null; // Reset input
                }
            };

            const analyzeImageWithAI = async () => {
                if (!rawImageFile) return alert("Please add a photo first.");
                if (!apiKey) return setShowSettings(true);

                setIsAnalyzing(true);
                try {
                    const base64Data = await fileToBase64(rawImageFile);
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: "Identify distinct items in this image. Return JSON: { \"items\": [\"item1\", \"item2\"], \"keywords\": \"category, synonyms, materials\" }" },
                                { inlineData: { mimeType: rawImageFile.type || "image/jpeg", data: base64Data } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0].content) {
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        setNewBox(prev => ({
                            ...prev,
                            items: [...new Set([...prev.items, ...(result.items || [])])],
                            keywords: prev.keywords ? `${prev.keywords}, ${result.keywords}` : result.keywords
                        }));
                    }
                } catch (error) {
                    alert("AI Error: " + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const handleAddBox = () => {
                const box = {
                    id: `bx-${Date.now().toString().slice(-4)}`,
                    ...newBox,
                    items: newBox.items.length ? newBox.items : ['Unsorted Items']
                };
                setBoxes([box, ...boxes]);
                setNewBox({ name: '', room: 'Living Room', category: 'General', items: [], images: [], keywords: '' });
                setRawImageFile(null);
                setView('dashboard');
            };

            const removePhoto = (idx) => {
                setNewBox(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== idx) }));
            };

            const filteredBoxes = boxes.filter(b => 
                b.name.toLowerCase().includes(searchQuery.toLowerCase()) || 
                b.items.some(i => i.toLowerCase().includes(searchQuery.toLowerCase())) ||
                (b.keywords && b.keywords.toLowerCase().includes(searchQuery.toLowerCase()))
            );

            // --- VIEWS ---

            // 1. Settings View
            if (showSettings) {
                return (
                    <div className="p-6 max-w-md mx-auto bg-white min-h-screen">
                        <div className="flex items-center gap-2 mb-6">
                            <button onClick={() => setShowSettings(false)}><Icon name="arrow-left" /></button>
                            <h2 className="text-xl font-bold">Settings</h2>
                        </div>
                        <label className="block text-sm font-bold mb-2">Google Gemini API Key</label>
                        <input 
                            className="w-full p-3 border rounded-xl mb-2 font-mono text-sm" 
                            type="password" 
                            value={apiKey} 
                            onChange={e => saveApiKey(e.target.value)} 
                            placeholder="AIza..." 
                        />
                        <p className="text-xs text-gray-500 mb-6">Required for smart detection.</p>
                        <button onClick={() => setShowSettings(false)} className="w-full bg-slate-900 text-white p-3 rounded-xl font-bold">Save</button>
                    </div>
                );
            }

            // 2. Add Box View
            if (view === 'add') {
                return (
                    <div className="p-6 max-w-md mx-auto bg-white min-h-screen animate-in">
                        <div className="flex items-center gap-2 mb-6">
                            <button onClick={() => setView('dashboard')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" /></button>
                            <h2 className="text-xl font-bold">Pack New Box</h2>
                        </div>
                        
                        {/* Photo Area */}
                        <div className="mb-4 space-y-3">
                            <input type="file" accept="image/*" ref={fileInputRef} onChange={handlePhotoUpload} className="hidden" />
                            
                            <div onClick={() => fileInputRef.current.click()} className="w-full h-40 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 active:bg-blue-50 transition-colors relative overflow-hidden">
                                {newBox.images.length > 0 && <img src={newBox.images[newBox.images.length-1]} className="absolute inset-0 w-full h-full object-cover opacity-40" />}
                                <Icon name="camera" size={32} className="mb-1 relative z-10" />
                                <span className="text-sm font-bold relative z-10">Add Photo</span>
                            </div>

                            {/* AI Button - Only shows if image exists */}
                            {newBox.images.length > 0 && (
                                <button 
                                    onClick={analyzeImageWithAI} 
                                    disabled={isAnalyzing}
                                    className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-md flex items-center justify-center gap-2 disabled:opacity-50"
                                >
                                    {isAnalyzing ? "Analyzing..." : <span><Icon name="sparkles" size={16} className="inline mr-1"/> Detect Items (AI)</span>}
                                </button>
                            )}

                            {/* Carousel */}
                            {newBox.images.length > 0 && (
                                <div className="flex gap-2 overflow-x-auto py-2">
                                    {newBox.images.map((src, i) => (
                                        <div key={i} className="relative w-16 h-16 shrink-0 rounded-lg overflow-hidden border">
                                            <img src={src} className="w-full h-full object-cover" />
                                            <button onClick={() => removePhoto(i)} className="absolute top-0 right-0 bg-red-500 text-white p-0.5"><Icon name="x" size={12} /></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Form Fields */}
                        <div className="mb-4">
                            <label className="text-xs font-bold text-slate-500 uppercase">Contents</label>
                            <div className="flex flex-wrap gap-2 mt-1 mb-2">
                                {newBox.items.map((item, i) => (
                                    <span key={i} className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm flex items-center gap-1">
                                        {item} <button onClick={() => setNewBox(prev => ({...prev, items: prev.items.filter((_,idx) => idx!==i)}))}><Icon name="x" size={12}/></button>
                                    </span>
                                ))}
                            </div>
                            <input 
                                className="w-full p-3 border rounded-xl" 
                                placeholder="Type item & enter..." 
                                onKeyDown={e => {
                                    if(e.key === 'Enter' && e.target.value) {
                                        setNewBox(prev => ({...prev, items: [...prev.items, e.target.value]}));
                                        e.target.value = '';
                                    }
                                }}
                            />
                        </div>

                        <input className="w-full p-4 bg-white border rounded-xl mb-3" placeholder="Box Name (e.g. Summer Clothes)" value={newBox.name} onChange={e => setNewBox({...newBox, name: e.target.value})} />
                        
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <select className="p-3 border rounded-xl" value={newBox.room} onChange={e => setNewBox({...newBox, room: e.target.value})}>
                                {ROOMS.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                            <select className="p-3 border rounded-xl" value={newBox.category} onChange={e => setNewBox({...newBox, category: e.target.value})}>
                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>

                        <button onClick={handleAddBox} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg sticky bottom-4">
                            <Icon name="check-circle-2" /> Save Box
                        </button>
                    </div>
                );
            }

            // 3. Dashboard View
            return (
                <div className="p-5 max-w-md mx-auto bg-slate-50 min-h-screen pb-24">
                    <header className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 text-white p-2 rounded-lg"><Icon name="package" /></div>
                            <h1 className="text-xl font-bold">BoxSnap</h1>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-2 bg-white rounded-full shadow-sm"><Icon name="settings" /></button>
                    </header>

                    {/* Stats */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-blue-600 text-white p-4 rounded-2xl shadow-lg"><p className="text-xs opacity-75 uppercase">Boxes</p><p className="text-3xl font-bold">{boxes.length}</p></div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm"><p className="text-xs text-slate-500 uppercase">Items</p><p className="text-3xl font-bold text-slate-800">{boxes.reduce((acc, b) => acc + b.items.length, 0)}</p></div>
                    </div>

                    {/* Search */}
                    <div className="relative mb-6">
                        <input className="w-full p-3 pl-10 rounded-xl border-none shadow-sm" placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                        <div className="absolute left-3 top-3 text-slate-400"><Icon name="search" size={18} /></div>
                    </div>

                    {/* List */}
                    <div className="space-y-3">
                        {filteredBoxes.map(box => (
                            <div key={box.id} className="bg-white p-4 rounded-xl shadow-sm flex flex-col gap-2">
                                <div className="flex justify-between">
                                    <div className="flex gap-3">
                                        <div className="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden">
                                            {box.images[0] ? <img src={box.images[0]} className="w-full h-full object-cover" /> : <Icon name="archive" className="text-slate-400" />}
                                        </div>
                                        <div>
                                            <h3 className="font-bold">{box.name}</h3>
                                            <p className="text-xs text-slate-500">{box.room}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => { if(confirm("Delete?")) setBoxes(boxes.filter(b => b.id !== box.id)); }} className="text-slate-300 hover:text-red-500"><Icon name="trash-2" size={18} /></button>
                                </div>
                                <div className="pl-16">
                                    <p className="text-sm text-slate-600 truncate">{box.items.join(', ')}</p>
                                    {box.keywords && searchQuery && box.keywords.includes(searchQuery.toLowerCase()) && (
                                        <p className="text-xs text-blue-500 mt-1 flex gap-1"><Icon name="sparkles" size={10}/> Match via AI: "{searchQuery}"</p>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <button onClick={() => setView('add')} className="fixed bottom-6 right-6 bg-slate-900 text-white p-4 rounded-full shadow-2xl flex items-center gap-2 hover:scale-105 transition-transform">
                        <Icon name="plus" /> <span className="font-bold pr-1">Add</span>
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


