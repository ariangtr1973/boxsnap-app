<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxSnap V2 (Dev + Numbered)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            var err = document.getElementById('error-display');
            var loader = document.getElementById('loading-screen');
            if(loader) loader.style.display = 'none';
            if(err) {
                err.style.display = 'block';
                err.innerHTML += "<strong>" + msg + "</strong><br><small>" + url + " (Line " + line + ")</small><br><br>";
            }
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .box-card { transition: transform 0.1s ease-in-out; }
        .box-card:active { transform: scale(0.98); }
        .modal-prevent-touch { touch-action: none; }
    </style>
</head>
<body>
    <div id="error-display" style="display:none; background: #fee2e2; color: #991b1b; padding: 20px; margin: 10px; border: 2px solid #b91c1c; border-radius: 8px; font-family: monospace; z-index: 99999; position: relative;"></div>

    <div id="loading-screen" style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <h2 style="margin-top: 15px; font-weight: bold; font-size: 1.2rem;">Loading BoxSnap...</h2>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        document.getElementById('loading-screen').style.display = 'none';

        try {
            const { useState, useEffect, useRef } = React;

            // --- ICONS ---
            const Icon = ({ d, className="" }) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>;
            const Icons = {
                arrowLeft: "m12 19-7-7 7-7 M19 12H5",
                camera: "M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 13m-3 0a3 3 0 1 0 6 0a3 3 0 1 0-6 0",
                settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",
                check: "M20 6 9 17l-5-5",
                sparkles: "m12 3-1.9 5.8a2 2 0 0 1-1.2 1.2L3 12l5.8 1.9a2 2 0 0 1 1.2 1.2L12 21l1.9-5.8a2 2 0 0 1 1.2-1.2L21 12l-5.8-1.9a2 2 0 0 1-1.2-1.2L12 3z",
                trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                plus: "M12 5v14 M5 12h14",
                package: "M16.5 9.4 7.5 4.21 M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z M3.3 7l8.7 5 8.7-5 M12 22v-10",
                search: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35",
                scan: "M3 7V5a2 2 0 0 1 2-2h2 M17 3h2a2 2 0 0 1 2 2v2 M21 17v2a2 2 0 0 1-2 2h-2 M7 21H5a2 2 0 0 1-2-2v-2 M12 12h.01",
                download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
                upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12",
                save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",
                close: "M18 6L6 18M6 6l12 12",
                zoom: "M15 15l6 6m-11-4a7 7 0 110-14 7 7 0 010 14z"
            };

            // --- COMPONENT: TAP-TO-ZOOM MODAL ---
            const ImageModal = ({ src, onClose }) => {
                const [zoomed, setZoomed] = useState(false);
                const [position, setPosition] = useState({ x: 0, y: 0 });
                const [start, setStart] = useState({ x: 0, y: 0 });
                const [isDragging, setIsDragging] = useState(false);

                const handleTouchStart = (e) => {
                    if (!zoomed) return;
                    setIsDragging(true);
                    const touch = e.touches[0];
                    setStart({ x: touch.clientX - position.x, y: touch.clientY - position.y });
                };

                const handleTouchMove = (e) => {
                    if (!isDragging || !zoomed) return;
                    e.preventDefault(); 
                    const touch = e.touches[0];
                    setPosition({ x: touch.clientX - start.x, y: touch.clientY - start.y });
                };

                const handleTouchEnd = () => setIsDragging(false);

                const toggleZoom = (e) => {
                    e.stopPropagation();
                    if (zoomed) { setZoomed(false); setPosition({ x: 0, y: 0 }); } else { setZoomed(true); }
                };

                return (
                    <div className="fixed inset-0 z-[9999] bg-black bg-opacity-95 flex items-center justify-center overflow-hidden modal-prevent-touch">
                        <button onClick={onClose} className="absolute top-4 right-4 z-50 text-white p-3 bg-gray-800 rounded-full opacity-80 shadow-lg">
                            <Icon d={Icons.close} className="w-6 h-6" />
                        </button>
                        <div className="w-full h-full flex items-center justify-center overflow-hidden relative" onClick={onClose}>
                            <img src={src} style={{ transform: `scale(${zoomed ? 2.5 : 1}) translate(${position.x / 2.5}px, ${position.y / 2.5}px)`, transition: isDragging ? 'none' : 'transform 0.2s ease-out', cursor: zoomed ? 'grab' : 'zoom-in', touchAction: 'none' }} className="max-w-full max-h-full object-contain" onClick={toggleZoom} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd} />
                        </div>
                        <div className="absolute bottom-10 left-0 right-0 text-center pointer-events-none">
                            <span className="bg-black bg-opacity-50 text-white px-4 py-2 rounded-full text-sm font-bold">
                                {zoomed ? "Drag to Pan â€¢ Tap to Zoom Out" : "Tap Image to Zoom In"}
                            </span>
                        </div>
                    </div>
                );
            };

            const QRScanner = ({ onScan, onClose }) => {
                useEffect(() => {
                    if (window.Html5QrcodeScanner) {
                        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                        scanner.render((txt) => { scanner.clear(); onScan(txt); }, console.warn);
                        return () => { try { scanner.clear(); } catch(e){} };
                    } else { alert("Scanner library failed to load. Check internet."); }
                }, []);
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-4 rounded-xl w-full max-w-sm">
                            <h2 className="text-lg font-bold mb-2 text-center">Scan Box Label</h2>
                            <div id="reader" className="w-full h-64 bg-gray-100"></div>
                            <button onClick={onClose} className="w-full mt-4 py-3 bg-red-100 text-red-600 rounded-lg font-bold">Cancel</button>
                        </div>
                    </div>
                );
            };

            // --- MAIN APP ---
            function App() {
                const [boxes, setBoxes] = useState(() => {
                    try {
                        const saved = localStorage.getItem('boxsnap_local_data');
                        return saved ? JSON.parse(saved) : [];
                    } catch { return []; }
                });
                
                const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_key') || "");
                const [view, setView] = useState('dashboard');
                const [newBox, setNewBox] = useState({ name: '', room: 'Living Room', items: [], images: [], status: 'Packing' });
                const [rawFile, setRawFile] = useState(null);
                const [selectedBox, setSelectedBox] = useState(null);
                const [selectedBoxImage, setSelectedBoxImage] = useState(null);
                const [isAnalyzing, setIsAnalyzing] = useState(false);
                const [showScanner, setShowScanner] = useState(false);
                const [searchQuery, setSearchQuery] = useState('');
                const [showSettings, setShowSettings] = useState(false);
                const [showFullImage, setShowFullImage] = useState(false); 
                const [previewImage, setPreviewImage] = useState(null);
                const [tempKey, setTempKey] = useState("");

                const fileRef = useRef(null);
                const qrRef = useRef(null);
                const importRef = useRef(null);
                const ROOMS = ['Living Room', 'Kitchen', 'Master Bedroom', 'Guest Room', 'Garage', 'Basement', 'Storage Unit'];

                useEffect(() => { localStorage.setItem('boxsnap_local_data', JSON.stringify(boxes)); }, [boxes]);

                const saveKey = () => {
                    const val = tempKey.trim();
                    if (!val) return alert("Please enter a key first.");
                    setApiKey(val);
                    localStorage.setItem('gemini_key', val);
                    alert("Key Saved!");
                };
                
                useEffect(() => { if (showSettings) setTempKey(apiKey); }, [showSettings, apiKey]);

                const compressImage = (file) => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 1024; 
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    };
                });

                const generateQRCode = (boxId) => {
                     const url = `${window.location.href.split('?')[0]}?box=${boxId}`;
                     if(qrRef.current) {
                        qrRef.current.innerHTML = ""; 
                        new QRCode(qrRef.current, { text: url, width: 128, height: 128 });
                     }
                };
                
                useEffect(() => { if (selectedBox && view === 'detail') setTimeout(() => generateQRCode(selectedBox.id), 100); }, [selectedBox, view]);

                const handlePhoto = async (e) => {
                    if(e.target.files[0]) {
                        const f = e.target.files[0];
                        setRawFile(f);
                        const b64 = await compressImage(f);
                        setNewBox(p => ({...p, images: [b64]}));
                    }
                };

                const openBox = (box) => {
                    setSelectedBox(box);
                    setSelectedBoxImage((box.images && box.images[0]) ? box.images[0] : null); 
                    setView('detail');
                };
                
                const analyze = async () => {
                    if (!apiKey) { alert("Please enter your Gemini API Key in Settings first."); setShowSettings(true); return; }
                    if (!newBox.images[0]) return alert("Add photo first.");
                    setIsAnalyzing(true);
                    try {
                        const b64 = newBox.images[0].split(',')[1]; 
                        // --- PROMPT: ORDERED & NUMBERED ---
                        const prompt = `Analyze this image of items.
                        1. ORDER: List items strictly from TOP-LEFT to BOTTOM-RIGHT.
                        2. TEXT PRIORITY: Use label text if visible (e.g., 'Neitra', 'Forstner Bits').
                        3. VISUAL ID: If no text, describe visually (e.g., 'Red Speed Square').
                        4. EXHAUSTIVE: List every item found.
                        Return ONLY a JSON object: { "items": ["Item 1", "Item 2"], "name": "Suggested Box Name" }`;
                        
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: b64 } }] }] })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error.message);
                        const json = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                        setNewBox(p => ({ ...p, items: [...new Set([...p.items, ...(json.items || [])])], name: p.name || json.name || "" }));
                    } catch (e) { alert("AI Error: " + e.message); }
                    setIsAnalyzing(false);
                };

                const saveBox = () => {
                    if (!newBox.name) return alert("Enter 'Box Name'.");
                    const newId = `box_${Date.now()}`;
                    const boxToSave = { ...newBox, id: newId, createdAt: Date.now() };
                    setBoxes(prev => [boxToSave, ...prev]);
                    setNewBox({ name: '', room: 'Living Room', items: [], images: [], status: 'Packing' });
                    setRawFile(null);
                    alert("Saved!");
                    setView('dashboard');
                };

                const deleteBox = (id) => {
                    if(confirm("Delete this box?")) {
                        setBoxes(prev => prev.filter(b => b.id !== id));
                        if (selectedBox && selectedBox.id === id) { setSelectedBox(null); setView('dashboard'); }
                    }
                };

                const handleScan = (txt) => {
                    setShowScanner(false);
                    const boxId = txt.includes('?box=') ? txt.split('?box=')[1] : txt;
                    const found = boxes.find(b => b.id === boxId);
                    if (found) { openBox(found); } else { alert("Box not found."); }
                };

                const exportData = async () => {
                    const fileName = `boxsnap_backup_${new Date().toISOString().slice(0,10)}.json`;
                    const json = JSON.stringify(boxes, null, 2);
                    try {
                        const file = new File([json], fileName, { type: "application/json" });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'BoxSnap Backup', text: 'Backup file' }); return; }
                    } catch (err) { console.log("Share failed", err); }
                    const blob = new Blob([json], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                };

                const importData = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const imported = JSON.parse(ev.target.result);
                            if (Array.isArray(imported)) { if(confirm(`Replace with ${imported.length} boxes?`)) { setBoxes(imported); alert("Loaded."); setShowSettings(false); } } else alert("Invalid file.");
                        } catch(err) { alert("Error reading file."); }
                    };
                    reader.readAsText(file);
                };

                const filteredBoxes = boxes.filter(b => {
                    const q = searchQuery.toLowerCase();
                    if (!q) return true;
                    const name = (b.name || "").toLowerCase();
                    const room = (b.room || "").toLowerCase();
                    const items = (b.items || []).map(i => i.toLowerCase());
                    return name.includes(q) || room.includes(q) || items.some(i => i.includes(q));
                });

                // --- RENDERS ---
                if (showScanner) return <QRScanner onScan={handleScan} onClose={() => setShowScanner(false)} />;
                if (showFullImage) return <ImageModal src={previewImage} onClose={() => { setShowFullImage(false); setPreviewImage(null); }} />;

                if (showSettings) return (
                    <div className="p-6 bg-white min-h-screen">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-900">Settings</h2>
                            <button onClick={() => setShowSettings(false)} className="p-2 bg-slate-100 rounded-full"><Icon d={Icons.check} /></button>
                        </div>
                        <div className="mb-6">
                            <label className="block font-bold text-xs text-slate-500 uppercase
